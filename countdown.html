<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>60초 비주얼 타이머</title>
    <style>
        body { 
            margin: 0; padding: 0; overflow: hidden; 
            background-color: #000; 
            display: flex; align-items: center; justify-content: center;
            height: 100vh; font-family: 'Apple SD Gothic Neo', sans-serif;
            user-select: none;
            touch-action: none; 
        }
        #bg-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; z-index: 1; }
        .bar { flex: 1; height: 100%; background-color: #FF9F00; transition: background-color 0.1s ease; }
        .bar.off { background-color: #000; }
        #content { position: relative; z-index: 10; text-align: center; color: white; text-shadow: 0px 4px 15px rgba(0,0,0,0.8); pointer-events: none; transition: transform 0.05s ease; }
        #timer { font-size: 160px; font-weight: 900; margin: 0; line-height: 1; }
        .warning { color: #ffeb3b !important; }
        #msg { position: fixed; bottom: 30px; font-size: 18px; color: rgba(255,255,255,0.4); z-index: 11; }
    </style>
</head>
<body id="main-body" ontouchstart="handleMultiTouch(event)" onclick="handleMultiTouch(event)">

    <div id="bg-container"></div>
    <div id="content"><p id="timer">60</p></div>
    <div id="msg">화면을 터치하면 시작/리셋됩니다</div>

    <script>
        let timeLeft = 60;
        let timerId = null;
        let isProcessing = false;
        const container = document.getElementById('bg-container');
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // 바 생성
        for (let i = 0; i < 60; i++) {
            const bar = document.createElement('div');
            bar.classList.add('bar');
            bar.id = `bar-${i}`;
            container.appendChild(bar);
        }

        // 기본 사운드 함수
        function playSound(freq, duration, vol = 0.5, type = 'triangle') {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type; 
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + 0.01); 
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        // 맑은 종소리 구현
        function playBellSound() {
            const now = audioCtx.currentTime;
            // 고음역대의 여러 주파수를 섞어 맑은 종소리 재현
            [1567.98, 2093.00, 3135.96].forEach((freq, i) => {
                playSound(freq, 1.5, 0.2 - (i * 0.05), 'sine');
            });
        }

        // 한국어 음성 출력 함수
        function speakNumber(num) {
            window.speechSynthesis.cancel();
            
            const numbers = ["", "일", "이", "삼", "사", "오", "육", "칠", "팔", "구", "십"];
            const msg = new SpeechSynthesisUtterance(numbers[num]);
            msg.lang = 'ko-KR';
            msg.rate = 1.4; 
            msg.pitch = 1.0;
            
            window.speechSynthesis.speak(msg);
        }

        function handleMultiTouch(event) {
            if (event && event.cancelable) event.preventDefault();
            if (isProcessing) return;
            isProcessing = true;
            setTimeout(() => { isProcessing = false; }, 300);

            // 전체화면 처리
            const doc = window.document;
            if (!doc.fullscreenElement && !doc.webkitFullscreenElement) {
                const requestFS = doc.documentElement.requestFullscreen || doc.documentElement.webkitRequestFullScreen;
                if (requestFS) requestFS.call(doc.documentElement).catch(() => {});
            }

            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            // 시작 시 맑은 종소리 재생
            playBellSound();
            
            const content = document.getElementById('content');
            content.style.transform = "scale(1.3)";
            setTimeout(() => { content.style.transform = "scale(1)"; }, 100);

            document.getElementById('msg').style.display = 'none';
            resetTimer();
            startTimer();
        }

        function startTimer() {
            if (timerId !== null) return;
            
            // 시작하자마자 60초 화면 업데이트
            updateDisplay();

            timerId = setInterval(() => {
                // 1. 숫자를 먼저 줄입니다.
                timeLeft--;
                
                // 2. 화면을 즉시 갱신합니다.
                updateDisplay();

                // 3. 갱신된 숫자(timeLeft)를 즉시 읽어줍니다.
                if (timeLeft <= 10 && timeLeft > 0) {
                    document.getElementById('timer').classList.add('warning');
                    speakNumber(timeLeft); 
                }

                if (timeLeft <= 0) {
                    clearInterval(timerId);
                    document.getElementById('timer').innerText = "0";
                    playFinalAlarm(); 
                    if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
                }
            }, 1000);
        }

        function updateDisplay() {
            document.getElementById('timer').innerText = timeLeft;
            const barsToOff = 60 - timeLeft;
            for (let i = 0; i < 60; i++) {
                const bar = document.getElementById(`bar-${59 - i}`);
                if (i < barsToOff) {
                    bar.classList.add('off');
                } else {
                    bar.classList.remove('off');
                }
            }
        }

        function resetTimer() {
            clearInterval(timerId);
            timerId = null;
            timeLeft = 60;
            document.getElementById('timer').classList.remove('warning');
            window.speechSynthesis.cancel(); // 초기화 시 음성 중단
            updateDisplay();
        }

        function playFinalAlarm() {
            playSound(523.25, 0.6, 0.4, 'triangle');
            playSound(659.25, 0.6, 0.4, 'triangle');
            setTimeout(() => {
                playSound(698.46, 0.6, 0.4, 'triangle');
                playSound(880.00, 0.6, 0.4, 'triangle');
            }, 400);
            setTimeout(() => {
                playSound(1046.50, 1.2, 0.5, 'triangle');
                playSound(1567.98, 1.2, 0.3, 'sine');
            }, 800);
        }
    </script>
</body>
</html>
